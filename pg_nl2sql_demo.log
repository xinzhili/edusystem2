2025-09-03 10:51:58,845 - INFO - [__main__] Initializing NL2SQL Pipeline for PostgreSQL...
2025-09-03 10:51:58,845 - INFO - [__main__] PGManager initialized for database: learning_db
2025-09-03 10:51:58,847 - INFO - [__main__] Initializing PostgreSQL database schema...
2025-09-03 10:51:58,979 - INFO - [__main__] Database schema already exists. Skipping creation.
2025-09-03 10:51:59,001 - INFO - [__main__] VectorStore initialized with DashScope model: text-embedding-v4
2025-09-03 10:51:59,018 - INFO - [__main__] LLMProvider initialized for 'dashscope'.
2025-09-03 10:51:59,302 - INFO - [__main__] Creating embeddings for 4 schemas...
2025-09-03 10:51:59,302 - INFO - [__main__] Leo Schema for embedding:
Table: students
Description: 学生基本信息表，包含姓名、年级、出生日期、性别、地区、教材版本和学校等信息。
DDL: CREATE TABLE students (
  student_id integer NOT NULL DEFAULT nextval('students_student_id_seq'::regclass)
  name character varying NOT NULL
  grade smallint NOT NULL
  date_of_birth date NOT NULL
  gender text NOT NULL
  region character varying NOT NULL
  textbook_version character varying NOT NULL
  school character varying NOT NULL
  photo bytea NOT NULL
  created_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP
);

2025-09-03 10:51:59,303 - INFO - [__main__] Leo Schema for embedding:
Table: original_input
Description: 原始输入数据表，存储学生的原始学习材料，如图片、文档等。
DDL: CREATE TABLE original_input (
  original_input_id integer NOT NULL DEFAULT nextval('original_input_original_input_id_seq'::regclass)
  student_id integer
  content bytea NOT NULL
  content_hash character varying NOT NULL
  created_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP
);

2025-09-03 10:51:59,304 - INFO - [__main__] Leo Schema for embedding:
Table: study_detail
Description: 学习明细表(存储学生错题记录,包含字段:details->>error_type标识错误类型)
DDL: CREATE TABLE study_detail (
  study_detail_id integer NOT NULL DEFAULT nextval('study_detail_study_detail_id_seq'::regclass)
  student_id integer
  original_input_id integer
  details jsonb NOT NULL  -- 错题详情，包含错题内容、错误类型、知识点分析等信息
  details_embedding USER-DEFINED
  created_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP
);

2025-09-03 10:51:59,305 - INFO - [__main__] Leo Schema for embedding:
Table: summary
Description: 学情汇总表，按时间段记录学生的学科优势和弱点分析。
DDL: CREATE TABLE summary (
  summary_id integer NOT NULL DEFAULT nextval('summary_summary_id_seq'::regclass)
  student_id integer
  grade smallint NOT NULL
  from_date date NOT NULL
  to_date date NOT NULL
  subject text NOT NULL
  details jsonb NOT NULL
  created_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP
);

2025-09-03 10:51:59,306 - INFO - [__main__] Creating embeddings for 4 schemas...
2025-09-03 10:52:00,559 - INFO - [__main__] Built embeddings for 4 schemas.
2025-09-03 10:52:00,559 - INFO - [__main__] NL2SQL Pipeline initialized successfully.
2025-09-03 10:52:00,561 - INFO - [__main__] ================================================================================
2025-09-03 10:52:00,561 - INFO - [__main__] Processing question: 请查找张三的错题详情？
2025-09-03 10:52:00,561 - INFO - [__main__] ================================================================================
2025-09-03 10:52:00,561 - INFO - [__main__] Step 1: Starting multi-path vector retrieval...
2025-09-03 10:52:00,561 - INFO - [__main__] LLM analyzing query dimensions...
2025-09-03 10:52:00,564 - INFO - [__main__] Calling LLM (dashscope, model: qwen-plus)...
2025-09-03 10:52:01,286 - INFO - [__main__] Identified 3 query dimensions: ['students', 'study_detail', 'error_records']
2025-09-03 10:52:01,286 - INFO - [__main__] Retrieving dimension: students
2025-09-03 10:52:01,457 - INFO - [__main__]   Retrieved students (Similarity: 0.5339)
2025-09-03 10:52:01,457 - INFO - [__main__]   Retrieved study_detail (Similarity: 0.4725)
2025-09-03 10:52:01,457 - INFO - [__main__] Retrieving dimension: study_detail
2025-09-03 10:52:01,708 - INFO - [__main__]   Retrieved summary (Similarity: 0.4035)
2025-09-03 10:52:01,708 - INFO - [__main__] Retrieving dimension: error_records
2025-09-03 10:52:01,873 - INFO - [__main__]   Retrieved original_input (Similarity: 0.3368)
2025-09-03 10:52:01,874 - INFO - [__main__] Multi-path retrieval completed, retrieved 4 relevant tables
2025-09-03 10:52:01,875 - INFO - [__main__] Step 2: Starting SQL generation...
2025-09-03 10:52:01,876 - INFO - [__main__] Calling LLM (dashscope, model: qwen-plus)...
2025-09-03 10:52:02,972 - INFO - [__main__] Generated SQL: SELECT sd.details
FROM students s
JOIN study_detail sd ON s.student_id = sd.student_id
WHERE s.name ILIKE '张三';
2025-09-03 10:52:02,972 - INFO - [__main__] Step 3: Starting database query execution...
2025-09-03 10:52:02,975 - INFO - [__main__] Executing PostgreSQL SQL: SELECT sd.details
FROM students s
JOIN study_detail sd ON s.student_id = sd.student_id
WHERE s.name ILIKE '张三';
2025-09-03 10:52:03,209 - INFO - [__main__] SQL executed successfully, returned 3 rows.
2025-09-03 10:52:03,214 - INFO - [__main__] Step 4: Starting natural language answer generation...
2025-09-03 10:52:03,219 - INFO - [__main__] Calling LLM (dashscope, model: qwen-plus)...
